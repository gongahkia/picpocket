<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicPocket (Audience View)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #111827;
            color: #fff;
            font-family: 'Inter', Arial, sans-serif;
            overflow: hidden;
        }
        body {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .viewer-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111827;
            position: relative;
            overflow: hidden;
        }
        #slideDisplay {
            max-width: 100vw;
            max-height: 100vh;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #222;
            touch-action: pinch-zoom;
            transition: box-shadow 0.2s;
            user-select: none;
            -webkit-user-drag: none;
            display: none;
        }
        #notConnectedMsg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.3em;
            color: #cbd5e1;
            text-align: center;
            z-index: 2;
        }
        .save-btn {
            position: fixed;
            right: 18px;
            bottom: 70px;
            z-index: 10;
            background: linear-gradient(90deg, #22c55e, #2563eb);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: 0 4px 16px 0 rgba(34,197,94,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        .save-btn:active {
            transform: scale(0.95);
        }
        .share-link-footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(17,24,39,0.96);
            padding: 10px 0 8px 0;
            z-index: 20;
        }
        .share-link-btn {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 24px;
            padding: 10px 22px;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.10);
            transition: background 0.2s;
        }
        .share-link-btn:active {
            background: #1e40af;
        }
        @media (max-width: 700px) {
            .save-btn {
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                bottom: 62px;
                right: 12px;
            }
            .share-link-btn {
                font-size: 0.98em;
                padding: 9px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <img id="slideDisplay" alt="Live Presentation Slide">
        <div id="notConnectedMsg">Not connected yet.<br>Waiting for presenter...</div>
    </div>
    <button id="saveButton" class="save-btn" title="Save Slide" style="display:none;">
        <i class="fa-solid fa-download"></i>
    </button>
    <div class="share-link-footer">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <button id="copyLinkButton" class="share-link-btn">
                <i class="fa-solid fa-link"></i> Share Link
            </button>
            <div id="sessionIdDisplay" style="margin-top: 4px; font-size: 0.97em; color: #a5b4fc; letter-spacing: 0.01em;"></div>
        </div>
    </div>
    <script>
        // Pinch/scroll zoom for image
        let scale = 1, lastScale = 1, startX = 0, startY = 0, originX = 0, originY = 0, dragging = false;
        const slideDisplay = document.getElementById('slideDisplay');
        const notConnectedMsg = document.getElementById('notConnectedMsg');
        const saveButton = document.getElementById('saveButton');
        const copyLinkButton = document.getElementById('copyLinkButton');
        const sessionIdDisplay = document.getElementById('sessionIdDisplay');

        let ws;
        let sessionId;
        let currentSlideImageDataURL = '';

        // Extract sessionId from the URL path: /join/:sessionId
        function getSessionId() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[2] || '';
        }

        function connectWebSocket() {
            sessionId = getSessionId();
            if (!sessionId) {
                notConnectedMsg.textContent = 'Error: No session ID found in URL.';
                sessionIdDisplay.textContent = '';
                return;
            }
            const joinUrl = `${window.location.origin}/join/${sessionId}`;
            copyLinkButton.dataset.link = joinUrl;
            sessionIdDisplay.textContent = `Session ID: ${sessionId}`;

            ws = new WebSocket(`ws://${window.location.host}/ws/audience?id=${sessionId}`);

            ws.onopen = () => {
                notConnectedMsg.textContent = 'Connected. Waiting for presenter...';
            };

            ws.onmessage = event => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'disconnected') {
                        slideDisplay.style.display = 'none';
                        saveButton.style.display = 'none';
                        notConnectedMsg.textContent = 'Presentation ended.';
                        ws.close();
                        return;
                    }
                } catch (e) {}
                currentSlideImageDataURL = event.data;
                slideDisplay.src = currentSlideImageDataURL;
                slideDisplay.style.display = 'block';
                saveButton.style.display = 'flex';
                notConnectedMsg.style.display = 'none';
                resetZoom();
            };

            ws.onclose = () => {
                slideDisplay.style.display = 'none';
                saveButton.style.display = 'none';
                notConnectedMsg.textContent = 'Disconnected. You may close this tab.';
                notConnectedMsg.style.display = 'block';
                sessionIdDisplay.textContent = '';
                copyLinkButton.disabled = true;
                copyLinkButton.style.background = '#6b7280'; // grey out
                copyLinkButton.style.cursor = 'not-allowed'; // show not-allowed cursor
                copyLinkButton.innerHTML = '<i class="fa-solid fa-link"></i> Share Link';
                copyLinkButton.removeAttribute('data-link');    
            };

            ws.onerror = (error) => {
                slideDisplay.style.display = 'none';
                saveButton.style.display = 'none';
                notConnectedMsg.textContent = 'Connection error. Please refresh.';
                notConnectedMsg.style.display = 'block';
                sessionIdDisplay.textContent = '';
                copyLinkButton.disabled = true;
                copyLinkButton.style.background = '#6b7280';
                copyLinkButton.style.cursor = 'not-allowed';
                copyLinkButton.innerHTML = '<i class="fa-solid fa-link"></i> Share Link';
                copyLinkButton.removeAttribute('data-link');
            };
        }

        // Save slide
        saveButton.onclick = () => {
            if (currentSlideImageDataURL) {
                const a = document.createElement('a');
                a.href = currentSlideImageDataURL;
                a.download = `slide_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('No slide to save yet!');
            }
        };

        // Copy link
        copyLinkButton.onclick = () => {
            const link = copyLinkButton.dataset.link;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link);
            } else {
                // fallback
                const temp = document.createElement('input');
                temp.value = link;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
            }
            copyLinkButton.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            setTimeout(() => {
                copyLinkButton.innerHTML = '<i class="fa-solid fa-link"></i> Share Link';
            }, 1200);
        };

        // Pinch/scroll/drag zoom logic
        function resetZoom() {
            scale = 1;
            lastScale = 1;
            slideDisplay.style.transform = '';
        }
        // Touch pinch zoom
        slideDisplay.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                lastScale = scale;
            } else if (e.touches.length === 1) {
                dragging = true;
                startX = e.touches[0].clientX - originX;
                startY = e.touches[0].clientY - originY;
            }
        });
        slideDisplay.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (!slideDisplay._lastDist) slideDisplay._lastDist = dist;
                scale = Math.max(1, Math.min(6, lastScale * (dist / slideDisplay._lastDist)));
                slideDisplay.style.transform = `scale(${scale})`;
            } else if (e.touches.length === 1 && dragging) {
                originX = e.touches[0].clientX - startX;
                originY = e.touches[0].clientY - startY;
                slideDisplay.style.transform = `scale(${scale}) translate(${originX/scale}px,${originY/scale}px)`;
            }
        });
        slideDisplay.addEventListener('touchend', function(e) {
            if (e.touches.length < 2) {
                slideDisplay._lastDist = null;
                lastScale = scale;
            }
            if (e.touches.length === 0) {
                dragging = false;
            }
        });
        // Mouse wheel zoom (desktop)
        slideDisplay.addEventListener('wheel', function(e) {
            e.preventDefault();
            let delta = e.deltaY < 0 ? 0.1 : -0.1;
            scale = Math.max(1, Math.min(6, scale + delta));
            slideDisplay.style.transform = `scale(${scale})`;
        }, { passive: false });

        // Double tap/double click to reset zoom
        let lastTap = 0;
        slideDisplay.addEventListener('click', function(e) {
            const now = Date.now();
            if (now - lastTap < 350) {
                resetZoom();
            }
            lastTap = now;
        });

        connectWebSocket();
    </script>
</body>
</html>